services:
  postgres:
    image: postgres:16
    container_name: pulse-db
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER_PROD}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_PROD}
      POSTGRES_DB: ${POSTGRES_DB_PROD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - app_backup:/backup
    networks:
      - app-network

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: pulse-backend
    restart: always
    depends_on:
      - postgres
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER_PROD}:${POSTGRES_PASSWORD_PROD}@postgres:5432/${POSTGRES_DB_PROD}?sslmode=disable
      PORT: 3002
      NODE_ENV: production
      # Database connection variables that the backend code expects
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER_PROD}
      DB_PASSWORD: ${POSTGRES_PASSWORD_PROD}
      DB_NAME: ${POSTGRES_DB_PROD}
      JWT_SECRET: ${JWT_SECRET_PROD}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET_PROD}
      BCRYPT_ROUNDS: 12
      RATE_LIMIT_WINDOW_MS: 900000
      RATE_LIMIT_MAX_REQUESTS: 5
      APP_URL: https://pulse.academy.alenia.io
      FRONTEND_URL: https://pulse.academy.alenia.io
      ALLOWED_ORIGINS: https://pulse.academy.alenia.io
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pulse_api.rule=Host(`pulse-api.academy.alenia.io`)"
      - "traefik.http.routers.pulse_api.entrypoints=websecure"
      - "traefik.http.routers.pulse_api.tls.certresolver=myresolver"
      - "traefik.http.routers.pulse_api.service=svc_pulse_api"
      - "traefik.http.services.svc_pulse_api.loadbalancer.server.port=3002"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=https://pulse-api.academy.alenia.io
    container_name: pulse-frontend
    restart: always
    depends_on:
      - backend
    environment:
      - VITE_API_URL=https://pulse-api.academy.alenia.io
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
    networks:
      - app-network
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pulse.rule=Host(`pulse.academy.alenia.io`)"
      - "traefik.http.routers.pulse.entrypoints=websecure"
      - "traefik.http.routers.pulse.tls.certresolver=myresolver"
      - "traefik.http.routers.pulse.service=svc_pulse"
      - "traefik.http.services.svc_pulse.loadbalancer.server.port=80"
      - "traefik.http.services.svc_pulse.loadbalancer.passhostheader=true"
      
  pgadmin:
    image: dpage/pgadmin4:9.8
    container_name: pulse-pgadmin
    restart: always
    depends_on:
      - postgres
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@pulse.com
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD_PROD:-admin}
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin_pulse.rule=Host(`pgadmin.pulse.academy.alenia.io`)"
      - "traefik.http.routers.pgadmin_pulse.entrypoints=websecure"
      - "traefik.http.routers.pgadmin_pulse.tls.certresolver=myresolver"
      - "traefik.http.routers.pgadmin_pulse.service=svc_pgadmin_pulse"
      - "traefik.http.services.svc_pgadmin_pulse.loadbalancer.server.port=80"
      
networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  app_backup:
  pgadmin_data: