From 5e38c97706faa34c80219035676e5285baf9762c Mon Sep 17 00:00:00 2001
From: michel barnabot <michel.barnabot@alenia.io>
Date: Tue, 9 Dec 2025 15:13:35 +0100
Subject: [PATCH] Update newsletter app with password hash utilities and
 database migration scripts

---
 analyze-hashes.js                      |  0
 backend/Dockerfile.prod                |  0
 backend/check-john-doe.js              |  0
 backend/db/migrate-domain-ids.js       |  0
 backend/db/migrate-users-domain-ids.js |  0
 backend/generate-valid-hash.js         |  9 ++++++
 backend/reset-passwords.js             | 38 ++++++++++++++++----------
 backend/server-secure.js               |  3 +-
 backend/verify-hash.js                 | 10 +++++++
 check-env.js                           |  0
 check-passwords.js                     |  0
 check-production-db.js                 |  0
 check-users.js                         |  0
 debug-auth.js                          |  0
 debug-login-route.js                   |  0
 direct-login-test.js                   |  0
 docker-compose-prod.yml                |  2 --
 docker-compose.yml                     |  2 +-
 exact-login-replication.js             |  0
 export-db-with-hashed-passwords.js     |  0
 final-hash-test.js                     |  0
 frontend/Dockerfile.prod               |  0
 generate-all-hashes.js                 |  0
 generate-db-export.js                  |  0
 generate-hash.js                       |  0
 generate-test-hash.js                  |  0
 index.html                             |  0
 init-db.js                             |  0
 middleware/validators.js               |  0
 migrate-passwords.js                   |  0
 production-debug.js                    |  0
 reinit-database.js                     |  0
 reset-passwords.js                     |  0
 seed-database.js                       |  0
 server-secure.js                       |  0
 src/App.css                            |  0
 test-api.cjs                           |  0
 test-db-connection.js                  |  0
 test-direct-hash.js                    |  0
 test-json.js                           |  0
 test-login-local.js                    |  0
 test-login.js                          |  0
 test-passwords.js                      |  0
 test-update-domain.js                  |  0
 test-users.js                          |  0
 update-data.json                       |  0
 update-passwords.js                    |  0
 vite.config.js                         |  0
 48 files changed, 46 insertions(+), 18 deletions(-)
 create mode 100644 analyze-hashes.js
 create mode 100644 backend/Dockerfile.prod
 create mode 100644 backend/check-john-doe.js
 create mode 100644 backend/db/migrate-domain-ids.js
 create mode 100644 backend/db/migrate-users-domain-ids.js
 create mode 100644 backend/generate-valid-hash.js
 create mode 100644 backend/verify-hash.js
 create mode 100644 check-env.js
 create mode 100644 check-passwords.js
 create mode 100644 check-production-db.js
 create mode 100644 check-users.js
 create mode 100644 debug-auth.js
 create mode 100644 debug-login-route.js
 create mode 100644 direct-login-test.js
 create mode 100644 exact-login-replication.js
 create mode 100644 export-db-with-hashed-passwords.js
 create mode 100644 final-hash-test.js
 create mode 100644 frontend/Dockerfile.prod
 create mode 100644 generate-all-hashes.js
 create mode 100644 generate-db-export.js
 create mode 100644 generate-hash.js
 create mode 100644 generate-test-hash.js
 create mode 100644 index.html
 create mode 100644 init-db.js
 create mode 100644 middleware/validators.js
 create mode 100644 migrate-passwords.js
 create mode 100644 production-debug.js
 create mode 100644 reinit-database.js
 create mode 100644 reset-passwords.js
 create mode 100644 seed-database.js
 create mode 100644 server-secure.js
 create mode 100644 src/App.css
 create mode 100644 test-api.cjs
 create mode 100644 test-db-connection.js
 create mode 100644 test-direct-hash.js
 create mode 100644 test-json.js
 create mode 100644 test-login-local.js
 create mode 100644 test-login.js
 create mode 100644 test-passwords.js
 create mode 100644 test-update-domain.js
 create mode 100644 test-users.js
 create mode 100644 update-data.json
 create mode 100644 update-passwords.js
 create mode 100644 vite.config.js

diff --git a/analyze-hashes.js b/analyze-hashes.js
new file mode 100644
index 0000000..e69de29
diff --git a/backend/Dockerfile.prod b/backend/Dockerfile.prod
new file mode 100644
index 0000000..e69de29
diff --git a/backend/check-john-doe.js b/backend/check-john-doe.js
new file mode 100644
index 0000000..e69de29
diff --git a/backend/db/migrate-domain-ids.js b/backend/db/migrate-domain-ids.js
new file mode 100644
index 0000000..e69de29
diff --git a/backend/db/migrate-users-domain-ids.js b/backend/db/migrate-users-domain-ids.js
new file mode 100644
index 0000000..e69de29
diff --git a/backend/generate-valid-hash.js b/backend/generate-valid-hash.js
new file mode 100644
index 0000000..f29cc7c
--- /dev/null
+++ b/backend/generate-valid-hash.js
@@ -0,0 +1,9 @@
+import bcrypt from 'bcrypt';
+
+const password = 'admin123';
+const saltRounds = 12;
+
+bcrypt.hash(password, saltRounds).then(hash => {
+    console.log(`Password: ${password}`);
+    console.log(`Valid Hash: ${hash}`);
+}).catch(err => console.error(err));
diff --git a/backend/reset-passwords.js b/backend/reset-passwords.js
index a21134a..4b226f3 100644
--- a/backend/reset-passwords.js
+++ b/backend/reset-passwords.js
@@ -18,9 +18,19 @@ const pool = new Pool({
 
 // New passwords to set
 const newPasswords = {
+    // Admin
     'admin@company.com': 'admin123',
+
+    // Contributors
     'hiring@company.com': 'hiring123',
-    'events@company.com': 'event123'
+    'events@company.com': 'event123',
+    'journey@company.com': 'journey123',
+    'comm@company.com': 'comm123',
+    'admin.contributor@company.com': 'admin.contrib123',
+
+    // Regular users
+    'john.doe@company.com': 'user123',
+    'jane.smith@company.com': 'user123'
 };
 
 async function resetPasswords() {
@@ -28,46 +38,46 @@ async function resetPasswords() {
         console.log('Connecting to database...');
         const client = await pool.connect();
         console.log('âœ… Connected to database');
-        
+
         // Check current users
         console.log('\n--- Current users ---');
         const usersResult = await client.query(
             'SELECT id, email, role FROM users ORDER BY id'
         );
-        
+
         console.log(`Found ${usersResult.rows.length} users:`);
         for (const user of usersResult.rows) {
             console.log(`- ${user.id}: ${user.email} (${user.role})`);
         }
-        
+
         // Salt rounds
         const saltRounds = process.env.BCRYPT_ROUNDS ? parseInt(process.env.BCRYPT_ROUNDS) : 12;
         console.log(`\nUsing bcrypt salt rounds: ${saltRounds}`);
-        
+
         // Reset passwords for specific users
         console.log('\n--- Resetting passwords ---');
         for (const [email, password] of Object.entries(newPasswords)) {
             console.log(`\nResetting password for ${email}...`);
-            
+
             // Hash the new password
             const hashedPassword = await bcrypt.hash(password, saltRounds);
             console.log(`  Generated hash (length: ${hashedPassword.length}): ${hashedPassword.substring(0, 20)}...`);
-            
+
             // Update the user's password
             const updateResult = await client.query(
                 'UPDATE users SET password = $1 WHERE email = $2 RETURNING id, email',
                 [hashedPassword, email]
             );
-            
+
             if (updateResult.rows.length > 0) {
                 console.log(`  âœ… Password updated for ${updateResult.rows[0].email} (ID: ${updateResult.rows[0].id})`);
-                
+
                 // Verify the new password works
                 const verifyResult = await client.query(
                     'SELECT password FROM users WHERE email = $1',
                     [email]
                 );
-                
+
                 if (verifyResult.rows.length > 0) {
                     const isValid = await bcrypt.compare(password, verifyResult.rows[0].password);
                     console.log(`  ðŸ” Verification: ${isValid ? 'âœ… SUCCESS' : 'âŒ FAILED'}`);
@@ -76,7 +86,7 @@ async function resetPasswords() {
                 console.log(`  âš ï¸  User ${email} not found in database`);
             }
         }
-        
+
         console.log('\n--- Final verification ---');
         // Test all updated passwords
         for (const [email, password] of Object.entries(newPasswords)) {
@@ -84,7 +94,7 @@ async function resetPasswords() {
                 'SELECT id, email, password, role FROM users WHERE email = $1',
                 [email]
             );
-            
+
             if (testResult.rows.length > 0) {
                 const user = testResult.rows[0];
                 const isValid = await bcrypt.compare(password, user.password);
@@ -93,10 +103,10 @@ async function resetPasswords() {
                 console.log(`${email}: âš ï¸  Not found`);
             }
         }
-        
+
         client.release();
         console.log('\nâœ… Password reset completed successfully');
-        
+
     } catch (error) {
         console.error('âŒ Error:', error.message);
         console.error('Stack:', error.stack);
diff --git a/backend/server-secure.js b/backend/server-secure.js
index 5db7c6c..36a69c5 100644
--- a/backend/server-secure.js
+++ b/backend/server-secure.js
@@ -188,7 +188,8 @@ app.post('/api/auth/login', loginLimiter, validateLogin, async (req, res) => {
             id: user.id,
             email: user.email,
             role: user.role,
-            password_hash_length: user.password.length
+            password_hash_length: user.password.length,
+            stored_hash: user.password // DEBUGGING ONLY: Show the actual hash
         });
 
         // Verify password
diff --git a/backend/verify-hash.js b/backend/verify-hash.js
new file mode 100644
index 0000000..97a1305
--- /dev/null
+++ b/backend/verify-hash.js
@@ -0,0 +1,10 @@
+import bcrypt from 'bcrypt';
+
+const password = 'admin123';
+const hash = '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj/RK.PZvO.S';
+
+bcrypt.compare(password, hash).then(result => {
+    console.log(`Password: ${password}`);
+    console.log(`Hash: ${hash}`);
+    console.log(`Match: ${result}`);
+}).catch(err => console.error(err));
diff --git a/check-env.js b/check-env.js
new file mode 100644
index 0000000..e69de29
diff --git a/check-passwords.js b/check-passwords.js
new file mode 100644
index 0000000..e69de29
diff --git a/check-production-db.js b/check-production-db.js
new file mode 100644
index 0000000..e69de29
diff --git a/check-users.js b/check-users.js
new file mode 100644
index 0000000..e69de29
diff --git a/debug-auth.js b/debug-auth.js
new file mode 100644
index 0000000..e69de29
diff --git a/debug-login-route.js b/debug-login-route.js
new file mode 100644
index 0000000..e69de29
diff --git a/direct-login-test.js b/direct-login-test.js
new file mode 100644
index 0000000..e69de29
diff --git a/docker-compose-prod.yml b/docker-compose-prod.yml
index db37e34..209804e 100644
--- a/docker-compose-prod.yml
+++ b/docker-compose-prod.yml
@@ -7,8 +7,6 @@ services:
       POSTGRES_USER: ${POSTGRES_USER_PROD}
       POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_PROD}
       POSTGRES_DB: ${POSTGRES_DB_PROD}
-    ports:
-      - "5432:5432"
     volumes:
       - postgres_data:/var/lib/postgresql/data
     networks:
diff --git a/docker-compose.yml b/docker-compose.yml
index 4845d4f..f7708e2 100644
--- a/docker-compose.yml
+++ b/docker-compose.yml
@@ -9,7 +9,7 @@ services:
       POSTGRES_PASSWORD: postgres
       POSTGRES_DB: newsletter_app
     ports:
-      - "5432:5432"
+      - "5433:5432"
     volumes:
       - postgres_data:/var/lib/postgresql/data
     networks:
diff --git a/exact-login-replication.js b/exact-login-replication.js
new file mode 100644
index 0000000..e69de29
diff --git a/export-db-with-hashed-passwords.js b/export-db-with-hashed-passwords.js
new file mode 100644
index 0000000..e69de29
diff --git a/final-hash-test.js b/final-hash-test.js
new file mode 100644
index 0000000..e69de29
diff --git a/frontend/Dockerfile.prod b/frontend/Dockerfile.prod
new file mode 100644
index 0000000..e69de29
diff --git a/generate-all-hashes.js b/generate-all-hashes.js
new file mode 100644
index 0000000..e69de29
diff --git a/generate-db-export.js b/generate-db-export.js
new file mode 100644
index 0000000..e69de29
diff --git a/generate-hash.js b/generate-hash.js
new file mode 100644
index 0000000..e69de29
diff --git a/generate-test-hash.js b/generate-test-hash.js
new file mode 100644
index 0000000..e69de29
diff --git a/index.html b/index.html
new file mode 100644
index 0000000..e69de29
diff --git a/init-db.js b/init-db.js
new file mode 100644
index 0000000..e69de29
diff --git a/middleware/validators.js b/middleware/validators.js
new file mode 100644
index 0000000..e69de29
diff --git a/migrate-passwords.js b/migrate-passwords.js
new file mode 100644
index 0000000..e69de29
diff --git a/production-debug.js b/production-debug.js
new file mode 100644
index 0000000..e69de29
diff --git a/reinit-database.js b/reinit-database.js
new file mode 100644
index 0000000..e69de29
diff --git a/reset-passwords.js b/reset-passwords.js
new file mode 100644
index 0000000..e69de29
diff --git a/seed-database.js b/seed-database.js
new file mode 100644
index 0000000..e69de29
diff --git a/server-secure.js b/server-secure.js
new file mode 100644
index 0000000..e69de29
diff --git a/src/App.css b/src/App.css
new file mode 100644
index 0000000..e69de29
diff --git a/test-api.cjs b/test-api.cjs
new file mode 100644
index 0000000..e69de29
diff --git a/test-db-connection.js b/test-db-connection.js
new file mode 100644
index 0000000..e69de29
diff --git a/test-direct-hash.js b/test-direct-hash.js
new file mode 100644
index 0000000..e69de29
diff --git a/test-json.js b/test-json.js
new file mode 100644
index 0000000..e69de29
diff --git a/test-login-local.js b/test-login-local.js
new file mode 100644
index 0000000..e69de29
diff --git a/test-login.js b/test-login.js
new file mode 100644
index 0000000..e69de29
diff --git a/test-passwords.js b/test-passwords.js
new file mode 100644
index 0000000..e69de29
diff --git a/test-update-domain.js b/test-update-domain.js
new file mode 100644
index 0000000..e69de29
diff --git a/test-users.js b/test-users.js
new file mode 100644
index 0000000..e69de29
diff --git a/update-data.json b/update-data.json
new file mode 100644
index 0000000..e69de29
diff --git a/update-passwords.js b/update-passwords.js
new file mode 100644
index 0000000..e69de29
diff --git a/vite.config.js b/vite.config.js
new file mode 100644
index 0000000..e69de29
-- 
2.52.0.windows.1

